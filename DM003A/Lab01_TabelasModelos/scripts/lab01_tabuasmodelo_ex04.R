library(tibble)   # tribble
library(dplyr)    # mutate, transmute, ...
library(tidyr)    # pivot_longer, pivot_wider
library(ggplot2)  # ggplot, geom_line, facet_wrap, ...
library(stringr)  # str_extract
library(readr)    # write_csv
library(microdatasus)

## Tábuas Coale & Demeny Padrão Oeste

## Coale & Demeny West Female Table
lx_west_female <- tribble(
    ~idade, ~n1, ~n2, ~n3, ~n4, ~n5, ~n6, ~n7, ~n8, ~n9, ~n10, ~n11, ~n12, ~n13, ~n14, ~n15, ~n16, ~n17, ~n18, ~n19, ~n20, ~n21, ~n22, ~n23, ~n24, ~n25,
    "0",1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
    "1",0.63444576156,0.66600679776,0.69443807444,0.72026293424,0.74388301408,0.76561315612,0.78570859648,0.80437156132,0.82177757072,0.8380620052,0.8533516382,0.86774307816,0.88120656228,0.893955513242331,0.906058303286453,0.917687051330823,0.928831391467264,0.939480775554604,0.949637305866833,0.959306371080035,0.968828720349441,0.977176716757063,0.984699447041673,0.990942506559241,0.995544922983919,
    "5",0.468360949406297,0.507761947219212,0.544562330219908,0.579062402438027,0.611511703633229,0.642119509240694,0.671068626393251,0.698508256218783,0.724580750831115,0.749393506870836,0.773060282711157,0.795663963517496,0.817475640696605,0.840117139846358,0.860356510155994,0.87953167740773,0.897706326068912,0.91494383554056,0.931322525386227,0.94691550949291,0.961260847454524,0.972590233732232,0.982295013245734,0.989915266002132,0.99522123327378,
    "10",0.434086134078148,0.473962652070875,0.511558519121757,0.54710203554957,0.580787765418741,0.61278233819249,0.643235333795346,0.672269234039261,0.700005784353532,0.726534797048125,0.751957065342626,0.776343749849522,0.799932640276806,0.824559553264191,0.846723366919306,0.867773193525725,0.887768055256039,0.906769502940974,0.924858042426656,0.942110442041313,0.957973845724345,0.97042089133412,0.981028559177848,0.989293197017307,0.994984763660996,
    "15",0.409245662187984,0.449294949615965,0.487320791157807,0.523498755572251,0.557982333716348,0.590905692278219,0.622392639995791,0.652544612426717,0.68146677628026,0.709234663800244,0.735938233765364,0.761638824760697,0.786561232863871,0.812771851844969,0.836334062697354,0.858765221923826,0.880118307845757,0.900450859993073,0.919842444556781,0.938370188549651,0.955340740855171,0.968657905764612,0.979980764141136,0.988766624555165,0.994778407143956,
    "20",0.378961474706503,0.418994567800666,0.45733583991673,0.494097841058544,0.529384207474199,0.563289131265679,0.595904223066087,0.627304323956827,0.657573302220601,0.68676823565288,0.714964768015698,0.742211253951551,0.768699124662184,0.796313343245938,0.821683871062759,0.845913346780291,0.8690429279277,0.891121233711108,0.912223427445547,0.932424612990159,0.951111776947723,0.965787477701379,0.978226260782616,0.987852277532744,0.994402183589486,
    "25",0.344135923214708,0.383861815067095,0.422303484230657,0.45950293441709,0.495506882548276,0.530363055489393,0.564124976166006,0.596835583055085,0.628552716915639,0.659310715046272,0.689167174425977,0.718154031191198,0.746422158974467,0.775384087658935,0.802908877369353,0.829302608956631,0.854588298734276,0.878799903152896,0.902003641343222,0.924269014902087,0.945081250194616,0.961767921456091,0.975723347597056,0.986516675081742,0.993835102562505,
    "30",0.308820314586812,0.347897377461508,0.386134604999317,0.423505627530952,0.460000587831435,0.495619978077574,0.530377766560929,0.564283184549991,0.597365987022796,0.629635700703595,0.66112975718595,0.691861641271477,0.721938270203203,0.752251057949137,0.781972672641169,0.810613636082994,0.838173593081518,0.864666142653801,0.890142935697933,0.914662568308811,0.937815347883545,0.956801020182839,0.97255252875734,0.984770066450748,0.993061604946507,
    "35",0.273118349204317,0.311166729375326,0.348855290359527,0.386093581586091,0.422817074158091,0.458979378861638,0.494554225331794,0.529515867398928,0.563864243272714,0.597582190585357,0.630684924785201,0.66316543838926,0.695083075991721,0.726928974936353,0.758829259793238,0.789753865218342,0.819674599821252,0.848579021108488,0.876497898935813,0.903472407278667,0.929204633445044,0.950626344813428,0.968488398045549,0.982442317167479,0.99197595252982,
    "40",0.23873768430172,0.275347771662087,0.312082571051808,0.348798107684709,0.385382257716483,0.421746374447363,0.457826764287047,0.49356435176013,0.528929865259798,0.56387959094507,0.598406023967439,0.63248100188285,0.666115303316848,0.699487863185733,0.733364151229663,0.766437207932855,0.79864874183004,0.829955621461084,0.86036120785074,0.889881611788212,0.91833300075333,0.942416130651165,0.962808272651399,0.978973349187383,0.990213327591018,
    "45",0.206898367553849,0.241681144211586,0.277043814429416,0.312803942379229,0.348813021179811,0.384948485557851,0.421115308847987,0.457225639265493,0.493224080561606,0.529042744648061,0.564652736746148,0.600005771455395,0.635066022632021,0.669754656730418,0.705214521367833,0.740109806823563,0.774354813984145,0.807875238090143,0.840643416678674,0.872644482076531,0.903749180156887,0.930790130854913,0.954217795537249,0.973261666725348,0.98696205641873,
    "50",0.177770996510456,0.210341507315842,0.243890700586796,0.278214514338105,0.313141384071544,0.348525394193647,0.384248467414194,0.420200656888251,0.456305456287318,0.492475049478626,0.528662070882458,0.564800699421814,0.600812958091367,0.636330976354249,0.672821353605008,0.709037261107005,0.744873399198402,0.780229171365405,0.815047220056304,0.849280052368999,0.882900402167471,0.913176840689445,0.940213777224647,0.963026109572747,0.980350199393539,
    "55",0.145975043824641,0.175597794065015,0.206611289809793,0.238803174432789,0.271988652084164,0.306005575797136,0.340717723594908,0.375996478364183,0.411746114894773,0.447860115537642,0.484272763094892,0.520900539482847,0.557620202526002,0.593763261008133,0.631023399750598,0.668381481798174,0.705717734130169,0.742907629778405,0.779863492504806,0.816501818314151,0.852841185264296,0.887031460062942,0.918658114070802,0.94652757919741,0.969027383852893,
    "60",0.113587240847696,0.139474691526992,0.167115462050598,0.196310673042483,0.226880013498381,0.258659445759381,0.291505971983532,0.325281570858169,0.359878208864438,0.395176520523367,0.431096343848949,0.467539863537481,0.504341343470107,0.540460437680075,0.577881250107058,0.615843086241726,0.654222921982949,0.69288112876393,0.731705118993279,0.770577504149827,0.809678170107436,0.848286064143164,0.885439140209521,0.919810322913534,0.949465461722011,
    "65",0.0779668950959475,0.0988258749827405,0.12174584968427,0.146573318108746,0.173158970655644,0.201358729337912,0.231040406471372,0.262071083022774,0.294341380780409,0.327728393380067,0.362143844319699,0.397481052730832,0.433533956255605,0.46887908988147,0.505673856516076,0.543573356564644,0.582467935616266,0.622216300648943,0.662689813103978,0.703741451001962,0.74563032966533,0.789501509490886,0.833660413827783,0.876755062950665,0.916581243789729,
    "70",0.0470506405024493,0.0621432517146755,0.0793354728864652,0.0985541082048905,0.119714608848269,0.142724633079919,0.167491837732357,0.193915303120532,0.221907635876793,0.251364471883368,0.28220749423423,0.31433858329484,0.347537675221419,0.379938063336694,0.414035279775541,0.449774188635426,0.487089531811575,0.525871178337013,0.566004929397969,0.607342239915421,0.65036872074313,0.698515749989326,0.749394690938427,0.802133932227154,0.854766800392218,
    "75",0.0221684053920912,0.0311600485903683,0.0419434151900285,0.0545444216618808,0.0689669394783251,0.085196697075546,0.103208321838719,0.122960553756289,0.144413915925688,0.167508843647385,0.192199878367497,0.218420674225088,0.245975858796118,0.272783223743456,0.301388590232902,0.332015306618591,0.364673812087322,0.399323627648676,0.435905508980451,0.474312267363316,0.51523427307362,0.564633277869275,0.619660840950161,0.680618097187722,0.746673474236998,
    "80",0.00732598920807079,0.0113047397594389,0.016438314755029,0.0228196054992297,0.0305220105617721,0.0396008683283948,0.050097271003426,0.0620354335935317,0.0754335803696726,0.0902909642659026,0.106609880769587,0.12437368250882,0.143456202172261,0.162104880208973,0.182247286163336,0.204352879720415,0.228511978988516,0.254772938616741,0.283161455778392,0.313654599795329,0.347020258280922,0.390614533517729,0.442011019525173,0.503149650087724,0.575435365019613,
    "85",0.00162413505038006,0.00275829925064598,0.00435877066841908,0.00650982345628856,0.00929140295188504,0.0127776645122825,0.0170368961120424,0.0221292507905158,0.0281104206175014,0.0350253131178657,0.0429175418473304,0.0518188870376692,0.0616938183986113,0.071484665225327,0.0822723261812461,0.0944940839261368,0.108285301543103,0.123762286434681,0.141029461271215,0.160159820500975,0.181831875372298,0.212616671316956,0.251426061315928,0.301515201578838,0.366799330071358,
    "90",0.000172882557401547,0.000333276067243316,0.000588389716506946,0.000969353142553717,0.0015103869730245,0.00224800809512885,0.00322045564317527,0.0044665959231094,0.00602623996365393,0.00793800470162446,0.0102413463953965,0.012973195163718,0.0161469124627983,0.0193811485709826,0.0230552307501405,0.0273949809765546,0.0325028710227069,0.0384829894463554,0.0454424560341903,0.0534819049278467,0.0630135347656203,0.077843429493963,0.098131129138154,0.127004157492453,0.169262465207974,
    "95",0.00000618126399727685,0.0000140502352039618,0.0000286837177554284,0.0000537898376991005,0.0000941706509476873,0.000155780731401453,0.000245767234235537,0.000372425566885522,0.00054525928942431,0.000774753066329158,0.00107258638597441,0.00145118906573501,0.00192015825558574,0.00241987706002726,0.00301343821412668,0.00375364318455215,0.00467428852118326,0.00581396068844411,0.00721667148136136,0.00893016716564189,0.0110863612413817,0.0148024489177717,0.0204368437440494,0.0294998055279815,0.0448479166843185
)

ex_west_female <- tribble(
    ~idade, ~n1, ~n2, ~n3, ~n4, ~n5, ~n6, ~n7, ~n8, ~n9, ~n10, ~n11, ~n12, ~n13, ~n14, ~n15, ~n16, ~n17, ~n18, ~n19, ~n20, ~n21, ~n22, ~n23, ~n24, ~n25,
    "0",19.9999349471324,22.4999870154542,24.9998500217813,27.4996923316668,29.9995750057828,32.4994118603141,34.9994658800987,37.4992386854469,39.9994546844054,42.4991294399384,44.999300531306,47.4990732961538,49.9989536838815,52.4982849937137,54.9986778612194,57.4984759327977,59.9986601122824,62.4982268142271,64.998006726454,67.4981519158119,69.9979871491755,72.4984475778736,74.9986083246262,77.4988677011031,79.99905963201,
    "1",30.3218121511543,32.6078993036586,34.8461096303067,37.0441406270119,39.2078465223487,41.3417181455475,43.4496395296289,45.5341771537568,47.5984021189171,49.6435691851102,51.6722766941493,53.6852917272826,55.6920153788026,57.6843177834147,59.6666319925124,61.6292306701506,63.5756671451261,65.5093046598384,67.4344212125755,69.3541135081558,71.2454982692113,73.1889798065673,75.1624688645143,77.2065237881041,79.3567729472694,
    "5",36.591564682915,38.3460471448866,40.0619614210594,41.745238145492,43.4003907380615,45.0308859991855,46.639724398596,48.228899068187,49.8007866574622,51.3563794321512,52.8976914418589,54.4253438031936,55.9276959401244,57.2937618357978,58.7632642763666,60.242493499137,61.7311228374558,63.2279015239239,64.7321838865717,66.2425707361432,67.7948052009377,69.5271083565321,71.3427799490711,73.285075254622,75.3820899452474,
    "10",34.3031251203067,35.9201338283156,37.5014454396887,39.0524536545861,40.5772652141047,42.0790360386495,43.5605022579783,45.0234797084334,46.4701428459529,47.9013962468229,49.3190880760202,50.7237876828192,52.1048798616176,53.3323139781853,54.6731877020726,56.0283022855508,57.3969944054995,58.7776042285965,60.1689157897206,61.5689535094007,63.019702664539,64.6775040094735,66.4319749387679,68.329742212086,70.399470630483,
    "15",31.2274475044975,32.7495137217179,34.2373281589669,35.6960057362504,37.129443259448,38.5406379554029,39.932188154593,41.305824346334,42.6636110540967,44.0064186482743,45.3360011388244,46.6529113958714,47.9464544141135,49.0680891752761,50.3200634099671,51.5887355884363,52.8732748808719,54.1718136614042,55.4828201253104,56.8039980972984,58.1862311150452,59.7904868727821,61.5002240605585,63.3647469051379,65.4135349311514,
    "20",28.515170783002,29.9298326268266,31.3116106871355,32.6653582703801,33.9947754009493,35.3027114019378,36.5916336266338,37.863196318209,39.1193557569681,40.3609576049527,41.589660194851,42.806007702261,44.0001609285625,45.0285094065312,46.1708870641625,47.3330164484305,48.5139746681175,49.7117466468861,50.9245048039788,52.1496281480545,53.4333862558331,54.9604633761639,56.6058648975252,58.4209901984567,60.4372998944334,
    "25",26.1377104646818,27.431181326385,28.6933939199786,29.9289091306702,31.1412057426726,32.3329658522909,33.5065081016118,34.663399292849,35.8054722122878,36.933542803254,38.049160074174,39.1528564862098,40.2357485292022,41.1737445637627,42.189736341961,43.2290083339754,44.2905702283502,45.3722831370797,46.4720259889953,47.5868459342981,48.7577521193012,50.1792956150799,51.7444000588313,53.4965638336619,55.4703017831144,
    "30",23.8294005236069,24.9981436817842,26.137538529678,27.2518230777068,28.3442300202083,29.4172537744526,30.4730468082193,31.5130743846934,32.5390327352263,33.5516981492468,34.5525001991724,35.5419520771271,36.512131176922,37.3599543664374,38.2496951540645,39.1657239292195,40.1070340783721,41.0714353023345,42.0565986069984,43.0593302665987,44.1153680599598,45.4262870573819,46.9046258409515,48.5868350357509,50.5114825640273,
    "35",21.6045026900964,22.642058521301,23.652802964366,24.6405577824357,25.6082372882975,26.5580912344247,27.4920594672376,28.4114689160656,29.3178470771312,30.2119058753702,31.0949320460729,31.9674017242581,32.8223585444667,33.5707940500042,34.336969533914,35.1315344890104,35.95351922111,36.8007659130805,37.6708462157541,38.5604484160934,39.5000809276176,40.70445988659,42.0905442173802,43.6957939236405,45.5639185295364,
    "40",19.3413451812171,20.2492546584891,21.1334567587773,21.9972593511545,22.8431848560343,23.6731816554338,24.4889329917249,25.2915913865946,26.0824881586578,26.8622458131275,27.63199057905,28.3921436072296,29.1366571466086,29.7857872832834,30.4389941874301,31.1212132686943,31.8316103291525,32.5681979484529,33.3286250722526,34.1096575397498,34.9369204246307,36.0364212845662,37.3235202411738,38.8414158584522,40.6403962663621,
    "45",16.9176486983122,17.7078282609303,18.4774516322232,19.2292905533453,19.9654617502626,20.6876033928811,21.3971385858947,22.0950405911664,22.782447060535,23.4598863379483,24.1283296787314,24.7881398571175,25.4340720402085,25.9926779227456,26.5502268100679,27.1357781547769,27.748697198545,28.3872715732398,29.0493832440983,29.732059978932,30.4587420278684,31.4540576712829,32.6361235140845,34.0541021959862,35.7657097401262,
    "50",14.2635626791688,14.958805055871,15.6357420476729,16.2967515207873,16.9436558864657,17.5778714821336,18.200636026805,18.8127997676437,19.4153624019953,20.0087931621269,20.5939519783929,21.1711676450799,21.7358697674144,22.2213928825486,22.7033170187233,23.2110236040997,23.7440598658509,24.3009987917635,24.8800143994436,25.4784864450076,26.1165973490095,27.0105926900989,28.0834966901854,29.3884132364767,30.9893919825293,
    "55",11.8040934259203,12.404113559149,12.9878147878683,13.5572211777195,14.1138957912993,14.6590635444927,15.1938029308789,15.7188641500067,16.2351281430791,16.7430225118161,17.2433098063636,17.7362979685804,18.2181168984374,18.6280778726245,19.0349277282489,19.4647346206333,19.9172055673832,20.3911945259597,20.8851825654206,21.3969367983253,21.9454626908251,22.7300984415137,23.6814489231457,24.8553509773335,26.3211141341276,
    "60",9.42851111786689,9.94331974425842,10.4428559828707,10.928970654771,11.40310653294,11.8664060563228,12.3198763607298,12.7642366566515,13.2003083841067,13.6285223621197,14.0495853466736,14.4638150294848,14.8680221852516,15.2088444626826,15.5462890824261,15.9034876378354,16.2802673275923,16.6757311860783,17.0886518713666,17.5171828815608,17.976747132185,18.6495390252847,19.472360538562,20.5017906844522,21.8098423778153,
    "65",7.54821886932668,7.96375601322414,8.36556206862695,8.75527611769084,9.13419266387863,9.50335011842247,9.86366439259782,10.2158095281443,10.5605289768245,10.8982469069208,11.2295962473412,11.5548952630842,11.8717097504191,12.1337715927237,12.3949466297194,12.6722267486428,12.9655573419609,13.2743057072209,13.597561048863,13.9339043585591,14.2975724898161,14.8445525783102,15.5203044318421,16.3809030891482,17.4990345770633,
    "70",5.79961763276098,6.12993473264981,6.44765953253849,6.75435450513968,7.05126151794002,7.3393826000723,7.61959257512659,7.89255256814541,8.15895657453587,8.41923434246559,8.67396232838926,8.92346261459878,9.16594319390533,9.36556544052468,9.56286567488771,9.77276188847255,9.99526697284793,10.2299506090946,10.4761629051931,10.7328561964019,11.0109537462066,11.4394771252676,11.9731286993004,12.662916640237,13.5764928137646,
    "75",4.39092863567186,4.63983570472476,4.87780241873645,5.10633503750478,5.32661561513855,5.539587634728,5.74605615223019,5.94663560126308,6.14193935182657,6.33236741063404,6.51841193307289,6.70036692654141,6.87697801082651,7.02321817146675,7.16529918904319,7.31679044414936,7.47775104224802,7.64791812867101,7.82686554135903,8.01387170247737,8.21695914659848,8.53544117160471,8.93551197775825,9.4595243465604,10.1655215642115,
    "80",3.22194025578241,3.3981795205817,3.56711549055875,3.72977628962925,3.88696548719202,4.03932193615094,4.18739037787137,4.33158313850552,4.47231552292314,4.60985244876446,4.7445281731094,4.87653623806528,5.00494512500733,5.11147988214227,5.2151653404609,5.3259144594378,5.44380870636744,5.56869580866943,5.70030405866321,5.83814326606097,5.98818828238186,6.22422974491211,6.5220256688768,6.91425322915699,7.44662818124387,
    "85",2.30937328482908,2.42904512859574,2.54394779985965,2.65476420869871,2.76202649220521,2.86615648233506,2.9675136218788,3.06636843385923,3.16299500805692,3.25756556155627,3.35030114088636,3.44132703457664,3.52999196544606,3.60364345667743,3.67540379358509,3.75213850902911,3.83392098222271,3.92066347099278,4.01219559732324,4.10819465583698,4.212849499178,4.3778126673017,4.58650425188184,4.86234422657155,5.23852411678473,
    "90",1.63113390649383,1.70904048000369,1.7838584405631,1.85603284551022,1.92590987895119,1.99376353497008,2.05982701661429,2.12427553985071,2.1872866755693,2.24897162844473,2.30947352749292,2.36887312253486,2.42674432353678,2.47482535360727,2.52167954176986,2.5717899242469,2.62520591398365,2.68187173236417,2.74167759282187,2.80441409342027,2.87282092583325,2.98067601640476,3.11716927630775,3.29766043488578,3.54395314201595,
    "95",1.13866009463034,1.18722824091738,1.23382098745367,1.27871942908597,1.32214220191741,1.36426237458269,1.40522714164333,1.44514730214401,1.4841347562147,1.52226003299603,1.55961315261144,1.59624538138125,1.63189578497392,1.66148513051062,1.69029282247644,1.72107298978436,1.75384946871427,1.78858094498664,1.82519262317135,1.8635485912576,1.90531226220612,1.97103231179628,2.05397360961902,2.16324624709837,2.3115885027346
)

## Coale & Demeny West Male Table
lx_west_male <- tribble(
    ~idade, ~n1, ~n2, ~n3, ~n4, ~n5, ~n6, ~n7, ~n8, ~n9, ~n10, ~n11, ~n12, ~n13, ~n14, ~n15, ~n16, ~n17, ~n18, ~n19, ~n20, ~n21, ~n22, ~n23, ~n24, ~n25,
    "0",1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
    "1",0.58049766038,0.6161452092,0.64826294576,0.67743500634,0.70411607322,0.72865975498,0.75135921514,0.77243970366,0.79209799062,0.81049728764,0.82776256762,0.8440215917,0.859845453367668,0.874883458468235,0.888055778716697,0.900852983627191,0.913237547670869,0.925186968263735,0.936671333005335,0.947683268619837,0.958680750416065,0.9690200418034,0.97839381250045,0.986529910721376,0.992893667171821,
    "5",0.429571292685077,0.470624990071738,0.509067670734534,0.545179123594612,0.579202655761036,0.61134057985521,0.641780120879294,0.670665248839711,0.698136688628905,0.72431658482177,0.749294308986372,0.773180446408687,0.79846268529548,0.821966448627214,0.842369586581117,0.862051884557836,0.881000444579342,0.899228502813804,0.916737187792765,0.93355742637061,0.949387020594024,0.963033176734909,0.975001916632832,0.984926638952758,0.992314914734876,
    "10",0.400538273474059,0.44161734995643,0.480419409366141,0.517153049282893,0.552006775756775,0.585139969780263,0.616706368065491,0.646822618872768,0.675608007007558,0.703167360442375,0.729574923986421,0.754930582233556,0.781926651218862,0.807029453186083,0.828905999059428,0.850083014737147,0.870536735676534,0.890272004685602,0.909281253582517,0.927590105634545,0.944824528036515,0.959710383233357,0.972802502628941,0.983653991905198,0.991711747170695,
    "15",0.381119930695723,0.422077669781735,0.460995969898029,0.49803671337573,0.533351773546335,0.567071365204334,0.59932607593191,0.630213440984409,0.659837479058001,0.688290517606341,0.715635808025789,0.74196521602135,0.770199598361517,0.796328241317667,0.81916929960461,0.841341758605927,0.862813423451031,0.883581954867979,0.903632083058174,0.922983891751058,0.941183430317313,0.956987361249115,0.970938745416583,0.982527870407977,0.991146182784926,
    "20",0.356291587652807,0.396906455340772,0.4357920829474,0.473053116000841,0.508795920285922,0.543114058015967,0.576108634665268,0.607852663334624,0.638430301590797,0.667917454597706,0.696362892846957,0.723847642157769,0.753233104610792,0.780604822825689,0.804641797345199,0.828071826439553,0.850850149998992,0.872962769399412,0.894381576789789,0.915116376665149,0.934712245451122,0.951948630949428,0.96730828721478,0.98018251052991,0.989857277890968,
    "25",0.323386988032438,0.36335264810705,0.402019306812614,0.439417936335889,0.47559531304222,0.510596295780978,0.544482221838719,0.577292668215833,0.60908432343646,0.639910124915603,0.669798448840577,0.698814747089994,0.729694514864653,0.758713697135088,0.784398503511145,0.809566699656655,0.834156138865844,0.858136645662659,0.881462260511741,0.904128460283924,0.92571218597349,0.944961152645446,0.962295201091559,0.976964139357663,0.988104826790113,
    "30",0.289871097593737,0.328919209063225,0.367135960051928,0.404480663490305,0.440940614263513,0.476510981790837,0.51121165340705,0.545046789406796,0.578043419160589,0.610229297619023,0.641610187961581,0.672233875243744,0.7047009328505,0.735488997801149,0.762980318329111,0.790054854208692,0.816632044086531,0.84266483091742,0.86808868117279,0.892884430038556,0.916593718968172,0.937982063216707,0.95738283112269,0.973891293243834,0.986491135076871,
    "35",0.25516465099642,0.292922710195337,0.330361445176884,0.367372155841723,0.403883775987519,0.43984138474979,0.475221975349584,0.509992357911547,0.544147565064482,0.577687702078301,0.61059338564783,0.642892248870261,0.677035526412815,0.709752508114733,0.739190855742855,0.768340012236909,0.797099392776228,0.825403228779513,0.853166066732825,0.880351889685412,0.906372653381546,0.930156088619591,0.951876596274909,0.970452379299924,0.984691111245811,
    "40",0.219613969784273,0.255584376306881,0.291779869509237,0.328032691097482,0.364218603211339,0.400235330090509,0.436017848927025,0.471495510438108,0.506630298902514,0.541393137135844,0.575737703553084,0.609669357488705,0.645471834658983,0.680063466075584,0.711501994449913,0.742828126170152,0.773919547297263,0.80468896331426,0.835025969116088,0.864873236832061,0.893528417179131,0.920146225588005,0.944679687607707,0.965833653606208,0.982186190038691,
    "45",0.183159466220904,0.21669433904766,0.251018627336157,0.285920187731785,0.321231361571296,0.356808892980276,0.392549401396972,0.428346911533906,0.464130938894101,0.499842912275907,0.535408762223699,0.570809985921382,0.60816958806755,0.644541688377723,0.677850560413295,0.711303480293655,0.744757594657304,0.778102592737,0.811198983577237,0.843962056121138,0.875448130527047,0.905510305084794,0.933644650131624,0.958307160908167,0.977760708356498,
    "50",0.148722834858222,0.179178110796341,0.210926225809576,0.24373611575768,0.277416319754254,0.311797863951567,0.346750427653852,0.382141831673347,0.417875662807343,0.453868722596918,0.490023181735641,0.526298749334797,0.56469775386559,0.602150360143969,0.636761264299122,0.671845385522861,0.707248186123106,0.742841635206049,0.77845930604549,0.813987394146804,0.84832694440912,0.882345223331841,0.914959770480875,0.944407731835787,0.968587963005674,
    "55",0.114352855977851,0.140884626233076,0.169151174852423,0.198930210131491,0.230028452685193,0.262268798630735,0.295507451973863,0.32959705892556,0.364423355579641,0.399884669211653,0.435864536731125,0.472303689339182,0.511210979816249,0.54896783954614,0.584238765678483,0.620385322561001,0.657254496710992,0.694710691331774,0.732567777665767,0.770685871718668,0.80777606757692,0.846254937284948,0.884316055812522,0.920070576510739,0.951081648129575,
    "60",0.0833910078477239,0.105356623804179,0.129326461898553,0.155118929429443,0.182567016066973,0.211510173655722,0.24181199195628,0.273328570811397,0.305943122207787,0.339548538842692,0.37402174181284,0.409293025272079,0.447295652795493,0.483981773017671,0.518660293176259,0.554626648579676,0.591749460183057,0.629904171942343,0.668903159153759,0.70859436140952,0.747792340212486,0.790449822689203,0.83423914413253,0.87740042226564,0.917419181979961,
    "65",0.0540445399587125,0.0706562207958936,0.0893591710488994,0.110043547803087,0.132597331470985,0.156902847798622,0.182854051982426,0.210331651753401,0.239234184587963,0.269464652205858,0.300907918238157,0.333494513026633,0.368958066828449,0.403067630212791,0.435773263932977,0.470181397064317,0.506204209300098,0.543749650527108,0.582650908397369,0.622762414180791,0.663117718230272,0.709424572508279,0.75897378025079,0.810441707970049,0.861598861650464,
    "70",0.0302450485065983,0.0413375623988108,0.0543263534696255,0.0691906988802787,0.0858943728309808,0.104385196972204,0.12460999309733,0.146497007093112,0.169981399122108,0.194996339354455,0.221454767426731,0.249303655181849,0.279977971228925,0.309413585394995,0.338102287363646,0.368779881075305,0.401423757338923,0.435999049430036,0.472390802266279,0.510489934495139,0.549713709582074,0.597258534059226,0.650464247201439,0.708899947180792,0.77130579060264,
    "75",0.0133726867705975,0.0194478507225404,0.0269447787049672,0.0359207139888206,0.0464131668141788,0.0584400586220278,0.0720100391492714,0.0871115817597752,0.103730760711036,0.121846347105582,0.141416798708525,0.162420764845814,0.185855829925799,0.208400747849447,0.230800790380465,0.255215444803322,0.281696180010212,0.310280384770286,0.340931723747839,0.373607598575634,0.408146922148746,0.452629658648051,0.504825417236125,0.565678979448192,0.635710733021052,
    "80",0.00389651834603932,0.00627203187831555,0.00944547332445906,0.0135069567984807,0.0185336326738208,0.0245886058940673,0.031725433557097,0.0399821589008003,0.0493905053283778,0.0599736277844476,0.071738267339345,0.0846990747564823,0.0994480593946704,0.113704713030776,0.128211334684739,0.144397982406148,0.162371603783948,0.182230736142426,0.204020665883529,0.227776330368253,0.253653140699957,0.2892388239996,0.333277381602408,0.388093165071281,0.456430336570456,
    "85",0.000773212824231666,0.00137092498112124,0.00224528791551261,0.00345649674584748,0.00506394429271255,0.00712448032502394,0.00969276083429575,0.0128181772537318,0.0165473611455608,0.0209229094818142,0.0259794538092733,0.0317536114838052,0.0385218448864716,0.0451581364872569,0.0521171909263707,0.0601166455255642,0.0692707244726678,0.0796958189489616,0.0914848878191209,0.10472694051097,0.119696582046786,0.141789402346656,0.170922577127521,0.210089879264835,0.26368242068571,
    "90",0.0000723590154315557,0.000145553213773118,0.0002662088332661,0.000451867066748717,0.000722398867834514,0.00109951876319344,0.00160659699460842,0.00226777833360432,0.00310816025836259,0.00415327313381213,0.00542778759247294,0.00695770192205581,0.00883026231938016,0.0107156550277211,0.012772559503725,0.015231198667003,0.0181587751280966,0.0216294700818169,0.0257156796008546,0.0304935705396065,0.0361549312090591,0.0452034028738185,0.0581098441437849,0.0771803770157088,0.106414309087131,
    "95",0.00000225190664918348,0.00000532741631967915,0.0000112410957271001,0.0000216733852024214,0.0000388554719470384,0.0000656097875458697,0.000105394523316254,0.000162278566125876,0.000240980225355301,0.000346841640623338,0.000485693117853551,0.000664077561941559,0.00089610642257287,0.00113992333074812,0.00141999689793955,0.00177226940549012,0.00221414663118222,0.00276645238040612,0.0034523588548578,0.00429844327459112,0.00536285782437546,0.00722875702742187,0.0101680096500026,0.0150620375698094,0.0237291642809883
)

ex_west_male <- tribble(
    ~idade, ~n1, ~n2, ~n3, ~n4, ~n5, ~n6, ~n7, ~n8, ~n9, ~n10, ~n11, ~n12, ~n13, ~n14, ~n15, ~n16, ~n17, ~n18, ~n19, ~n20, ~n21, ~n22, ~n23, ~n24, ~n25,
    "0",18.0346154906788,20.4440036522891,22.8526864538164,25.2604719506788,27.667608065772,30.0739074814103,32.480190753193,34.8857300994916,37.2910630260736,39.6966030372361,42.1009481750816,44.5058083289982,47.0839614001317,49.5480614487278,51.818069314905,54.1248418556186,56.4626814417885,58.8311914905582,61.224716610992,63.6402934067937,66.0324902879215,68.5726756029926,71.2063527555171,73.9076058718061,76.6489699220441,
    "1",29.829029882548,31.9749079729192,34.0731340957049,36.1312749818931,38.1554282291187,40.1500223466805,42.1193743835996,44.0658284870113,45.9922355614651,47.900925082135,49.7924753631736,51.6696661452947,53.7048428476481,55.5867059330392,57.3084181904755,59.0457205163661,60.7992021654083,62.5676059095834,64.3489572495693,66.1428979085798,67.8715464037939,69.7607651988868,71.7765154012747,73.9156319948445,76.1971110802057,
    "5",35.8342019135933,37.443704514906,39.0201317571846,40.5684353845998,42.0926190354426,43.5955480130181,45.080094753407,46.5477158593983,48.0003063631616,49.4394135871286,50.8653014924356,52.2799238343962,53.7295298738773,55.0782577748166,56.3432329717695,57.6424223222548,58.9730143347827,60.3325644588753,61.7164090694755,63.1210924573518,64.5209910328714,66.1847493770665,68.0206918162976,70.033327772998,72.2406002762216,
    "10",33.2685529954188,34.7554033532636,36.212799922944,37.6450262875961,39.0555570534731,40.4468633183644,41.8214602791229,43.1805809089494,44.5258863969152,45.8587335846585,47.1793047777731,48.4893586303327,49.8182090471934,51.0560355280696,52.2218476485518,53.4223281436089,54.6548156715496,55.9168986591188,57.2040223706349,58.512684961456,59.8216933587589,61.4061098765097,63.1693930996881,65.1210255332613,67.2831691577587,
    "15",29.8311384878476,31.244006855401,32.6290296240442,33.9901730938389,35.3306601489281,36.6527785694235,37.9588718901508,39.2500758503407,40.5279412728771,41.7937361226318,43.0476180898976,44.2912457364102,45.5371531163717,46.7071970411052,47.8116561498957,48.950354932894,50.1207745722171,51.3205881031884,52.5453863388584,53.7917210183517,55.0430633600425,56.5734374050494,58.285658563159,60.1926838271396,62.3200784426549,
    "20",26.7287528892414,28.0605669775757,29.365748342665,30.6479984406719,31.9103294341729,33.1548808714433,34.3838505868185,35.5983042062739,36.7997013503218,37.9892378273314,39.1670681936292,40.334758459395,41.5043078199602,42.5956311082622,43.6279354421676,44.6931239128404,45.7889345541608,46.9132513636862,48.061966869355,49.2318307657624,50.4061363374254,51.859122562409,53.4946554864,55.3304903769069,57.3978406646354,
    "25",24.1838515250581,25.4117235217138,26.6142812154362,27.7949282511864,28.9564402957429,30.1007946187734,31.2300250614992,32.3451270415417,33.4474595507774,34.5381397940867,35.6173310856807,36.6864904496763,37.7592885310341,38.7496229117211,39.6867601962215,40.6552911993972,41.6532769963997,42.6788564118059,43.728288679056,44.798549633341,45.8709223442988,47.22336721862,48.7597916846015,50.5041981756794,52.4950272521245,
    "30",21.679450461841,22.7998056699308,23.8959931423425,24.9711560961492,26.0278632261381,27.0679543598488,28.0933182819505,29.1048984600375,30.1039666700177,31.0915729299604,32.0679021015934,33.0343080287929,34.0062807237436,34.8911275782355,35.7278500888466,36.5951360170125,37.4913206814148,38.4147274471847,39.3619018612733,40.3299529733763,41.3013905763202,42.5553889945612,43.9966394398248,45.6553466973074,47.576645007364,
    "35",19.2745588593962,20.2821064838361,21.2665779306872,22.2308815649984,23.1773987864621,24.1078488716051,25.0239872433531,25.926718204868,26.8172343590877,27.6965252930974,28.5648067775527,29.4233309897721,30.2896218292273,31.0620431613131,31.7940074203787,32.5559072831991,33.3463207062579,34.1637184303979,35.0048994076436,35.8670701917308,36.7378219380767,37.8915582279996,39.2361028529989,40.807918462059,42.6588627017555,
    "40",16.9738039344972,17.8652862747321,18.7348290478742,19.5851236700791,20.4183773387733,21.236199304386,22.0402185351446,22.8313070989474,23.6105823470088,24.3789763708837,25.1367396996189,25.8850226444675,26.6436494432435,27.3045901265436,27.93012345147,28.5847209033504,29.267210953192,29.9762301864245,30.7088631887191,31.4624515829183,32.2285441579619,33.2754794507463,34.5152098239797,35.990633046548,37.7610269306282,
    "45",14.8346437128646,15.6049404558523,16.3548564188346,17.0868220754885,17.8028359686799,18.5043707344922,19.1929058564357,19.8692640254819,20.5344711213265,21.1893878885927,21.8342891557144,22.4702110069912,23.1183732013644,23.6661016849357,24.1876203515933,24.7363518841795,25.3114002953828,25.9116268905847,26.5344922763662,27.1775879287211,27.8404508521225,28.7712925586898,29.8924256484532,31.2528812755706,32.9201706549349,
    "50",12.667563861242,13.3279087490671,13.9693498246108,14.5940957440163,15.2039668549068,15.8003200515946,16.3845053442367,16.9573047927971,17.5196642948505,18.0723818078839,18.6157546274401,19.1507159754629,19.6979284799143,20.1491532452109,20.5806387004768,21.0364401029083,21.5159154977943,22.0181753752267,22.5411056637698,23.0826448074951,23.6473932341514,24.4583933846151,25.4497787748648,26.6745833408798,28.207309474571,
    "55",10.6934782936257,11.2438337798004,11.7772237201789,12.2955774426616,12.8004939318445,13.2931804966978,13.7748310954055,14.2461641657159,14.7080269983168,15.1611387666357,15.6058031316203,16.0428394592236,16.486843572555,16.8492677814458,17.1970806875937,17.5657160770267,17.9547438497871,18.36350533889,18.7903113269071,19.2334764706491,19.7039858777502,20.3905896236199,21.2415795076566,22.3113897871578,23.6786566230237,
    "60",8.69846710763913,9.15867801488632,9.60325247720365,10.0339644755742,10.452287813622,10.8593508573987,11.2562535072232,11.6436890493709,12.0224449183031,12.3931922715322,12.7562535624374,13.1123646868037,13.4711734954567,13.762570958657,14.0427092561928,14.3401090798268,14.6544717319997,14.9853042725914,15.3312668151756,15.6910066628169,16.0759721506299,16.6465907816622,17.3605784627478,18.2700034614383,19.4520866743995,
    "65",7.00996664641302,7.37974995667014,7.73556699360387,8.0790206594488,8.41144499311216,8.73387525237306,9.04730390585687,9.35238525500368,9.64983402393572,9.94026095513258,10.2239936454886,10.5016741726172,10.7793531094261,11.0034104429429,11.2191901356767,11.4486494649925,11.6915998112016,11.9476962688948,12.215929487048,12.4952687176038,12.7967418063446,13.2508889359384,13.8243448510104,14.5646595415325,15.5438811488994,
    "70",5.48012023147071,5.7697867191454,6.04728166176498,6.31404511891708,6.57127568057817,6.81991358022827,7.06084350255298,7.29467139391823,7.5220344279269,7.74347690794147,7.95931663690161,8.17010166325048,8.37884198501309,8.54697483505259,8.70910147094914,8.88171730912028,9.06470782947849,9.25783867210186,9.46037074353406,9.67154347056233,9.90029384776864,10.2511416737027,10.6967743101361,11.2784593547823,12.0591592583753,
    "75",4.11397715358097,4.33757003604141,4.55044647117025,4.75401641322436,4.94942813292331,5.1375781726504,5.31928032019438,5.49510756894842,5.6656335001425,5.83134375734449,5.99254056257824,6.14968701631892,6.30539522845449,6.42950193296204,6.54928122932175,6.67692308351985,6.81236243570476,6.95544583149858,7.10564530562464,7.26241526358058,7.43241914693054,7.6959130110128,8.03264072406889,8.47570795757183,9.07676754731756,
    "80",3.03910158069125,3.19780072016219,3.34923852031814,3.4943834953738,3.63402232220216,3.76876626084202,3.89917137348475,4.0256245546698,4.1485161250912,4.26817599302656,4.38480394129345,4.49871820728463,4.61180180573725,4.70208617283517,4.78935012257917,4.88248045371852,4.98145609606683,5.08619251716175,5.19633108596043,5.3114987943202,5.43663223728253,5.63108109076997,5.88045968951369,6.21010541579316,6.66004345773572,
    "85",2.19677679735329,2.30510114442623,2.40862567374316,2.50799760710372,2.60374150100244,2.69626346960494,2.78593345061495,2.87300663413959,2.95774187845113,3.04035769223302,3.12098376826823,3.19983259906846,3.27820293582727,3.34084164231725,3.40144286808782,3.46618089742672,3.53505316173928,3.60801348368437,3.68482480763625,3.76523944083578,3.85272332065432,3.98889515587501,4.16393737762135,4.39601010422274,4.71402574937662,
    "90",1.56748924320825,1.63862736723906,1.7066371776449,1.77194296082393,1.8348879961701,1.89573757942161,1.9547332432958,2.01204112952272,2.06782991430041,2.12224186730367,2.17536089967808,2.22732560751882,2.2789909937838,2.32029667451582,2.36026821267353,2.40297840411105,2.44842736060522,2.49658644960456,2.54730099391355,2.60040913420452,2.65820245498397,2.74819287949139,2.86392774240104,3.0174627015146,3.22801464152989,
    "95",1.10705738884498,1.15195580443105,1.19485362082592,1.23602049182387,1.27567452020571,1.31398431880422,1.35110325746572,1.38713704348234,1.42219280922885,1.45636092521459,1.48969499742618,1.52228284598256,1.55466093157713,1.58053047738766,1.60555040205545,1.6322689722474,1.6606827873856,1.69077015955169,1.72243044519629,1.75555847747074,1.79157750071222,1.84759575192613,1.91951523332167,2.0146989234688,2.14479053393493
)

## Tábua de vida masculina de Pernambuco em 2010
tvpe2010censo_male <- tribble(
    ~idade, ~populacao, ~obitos, ~mxn, ~x, ~qxn, ~lx, ~dxn, ~Lxn, ~Tx, ~ex,
    "Menos de 1 ano",66758,1427,0.02138,0,0.02098,100000,2098,98118,6682774,66.8,
    "1 a 4 anos",277508,227,0.00082,1,0.00327,97902,320,390838,6584656,67.3,
    "5 a 9 anos",378324,123,0.00033,5,0.00162,97582,159,487516,6193818,63.5,
    "10 a 14 anos",423568,238,0.00056,10,0.00281,97424,273,486436,5706302,58.6,
    "15 a 19 anos",407498,1042,0.00256,15,0.01271,97150,1234,482666,5219866,53.7,
    "20 a 24 anos",402836,1693,0.0042,20,0.02079,95916,1994,474594,4737200,49.4,
    "25 a 29 anos",379000,1530,0.00404,25,0.01998,93922,1877,464916,4262606,45.4,
    "30 a 34 anos",344709,1526,0.00443,30,0.02189,92045,2015,455187,3797690,41.3,
    "35 a 39 anos",301541,1468,0.00487,35,0.02405,90030,2165,444737,3342503,37.1,
    "40 a 44 anos",271173,1675,0.00618,40,0.03041,87865,2672,432643,2897766,33,
    "45 a 49 anos",233862,1985,0.00849,45,0.04157,85193,3541,417110,2465122,28.9,
    "50 a 54 anos",191000,2066,0.01082,50,0.05266,81652,4300,397508,2048012,25.1,
    "55 a 59 anos",152743,2350,0.01539,55,0.07408,77352,5730,372432,1650504,21.3,
    "60 a 64 anos",128560,2780,0.02163,60,0.10258,71621,7347,339738,1278072,17.8,
    "65 a 69 anos",95597,3094,0.03237,65,0.14973,64274,9624,297311,938334,14.6,
    "70 a 74 anos",73653,3568,0.04845,70,0.21607,54650,11808,243730,641023,11.7,
    "75 a 79 anos",46054,3218,0.06988,75,0.29742,42842,12742,182353,397293,9.3,
    "80 a 84 anos",31232,3208,0.10272,80,0.40864,30100,12300,119748,214940,7.1,
    "85 a 89 anos",16348,2560,0.15658,85,0.56264,17800,10015,63961,95192,5.4,
    "90 anos e mais",8717,2173,0.24926,90,1,7785,7785,31231,31231,4
) %>%
    mutate(
        idade = factor(
            c('<1','1-4','5-9','10-14','15-19','20-24','25-29',
              '30-34','35-39','40-44','45-49','50-54','55-59',
              '60-64','65-69','70-74','75-79','80-84','85-89',
              '90-94'
              )
        )
    )

## Tábua de vida feminina de Pernambuco em 2010
tvpe2010censo_female <- tribble(
    ~idade, ~populacao, ~obitos, ~mxn, ~x, ~qxn, ~lx, ~dxn, ~Lxn, ~Tx, ~ex,
    "Menos de 1 ano",64528,1041,0.01614,0,0.01591,100000,1591,98565,7546599,75.5,
    "1 a 4 anos",268115,194,0.00072,1,0.00289,98409,285,392926,7448034,75.7,
    "5 a 9 anos",366005,97,0.00027,5,0.00133,98125,130,490299,7055108,71.9,
    "10 a 14 anos",411963,140,0.00034,10,0.0017,97995,167,489556,6564809,67,
    "15 a 19 anos",406100,230,0.00057,15,0.00282,97828,276,488449,6075253,62.1,
    "20 a 24 anos",414746,306,0.00074,20,0.00369,97552,360,486859,5586804,57.3,
    "25 a 29 anos",400641,369,0.00092,25,0.0046,97192,447,484843,5099946,52.5,
    "30 a 34 anos",372344,447,0.0012,30,0.00598,96745,578,482280,4615103,47.7,
    "35 a 39 anos",333661,565,0.00169,35,0.00843,96167,811,478807,4132822,43,
    "40 a 44 anos",305896,774,0.00253,40,0.01257,95356,1198,473783,3654016,38.3,
    "45 a 49 anos",268313,1017,0.00379,45,0.01878,94157,1768,466367,3180233,33.8,
    "50 a 54 anos",225663,1316,0.00583,50,0.02875,92389,2656,455306,2713866,29.4,
    "55 a 59 anos",190010,1589,0.00836,55,0.04095,89733,3674,439480,2258560,25.2,
    "60 a 64 anos",160049,2089,0.01305,60,0.0632,86059,5439,416697,1819080,21.1,
    "65 a 69 anos",124093,2479,0.01998,65,0.09514,80620,7671,383924,1402383,17.4,
    "70 a 74 anos",100594,3224,0.03205,70,0.14836,72950,10823,337690,1018459,14,
    "75 a 79 anos",66426,3229,0.0486,75,0.21669,62127,13462,276977,680768,11,
    "80 a 84 anos",46240,3690,0.07981,80,0.33267,48664,16189,202849,403791,8.3,
    "85 a 89 anos",24574,3051,0.12416,85,0.47374,32475,15385,123915,200942,6.2,
    "90 anos e mais",15806,3507,0.22188,90,1,17091,17091,77028,77028,4.5
) %>%
    mutate(
        idade = factor(
            c('<1','1-4','5-9','10-14','15-19','20-24','25-29',
              '30-34','35-39','40-44','45-49','50-54','55-59',
              '60-64','65-69','70-74','75-79','80-84','85-89',
              '90-94'
              )
        )
    )

## Óbitos provenientes do SIM/Datasus
sim <- fetch_datasus(
    year_start = 2010
   ,year_end = 2010
   ,uf = 'PE'
   ,information_system = "SIM-DO" ) %>%
    filter( IDADE != '000', IDADE != '999' )

sim <- process_sim( sim )

pe2010_sim <- sim %>%
    mutate(
        fonte = 'SIM',
        sexo = SEXO,
        idade_aux = case_when(
            !is.na(IDADEanos) ~ IDADEanos,
            TRUE ~ 0
        ),
        idade = cut(
            x = idade_aux,
            breaks = c(0,1,seq(from=5,to=90,by=5),150),
            labels = c('<1','1-4','5-9','10-14','15-19','20-24','25-29',
                       '30-34','35-39','40-44','45-49','50-54','55-59',
                       '60-64','65-69','70-74','75-79','80-84','85-89',
                       '90-94'
                       ),
            include.lowest = TRUE,
            right = FALSE
        )
    ) %>%
    count( fonte, sexo, idade ) %>%
    rename( obitos = n) %>%
    na.omit() %>%
    pivot_wider(
        id_cols = c(fonte,idade),
        names_from = sexo,
        values_from = obitos
    )

## confeccao das tabuas de vida por sexo usando obitos do Datasus/SIM

## Função para cálculo das tábuas de vida
tabua_vida <- function(tv){
    for( i in 1:nrow(tv) ){
        ## nax  -- Preston (2000), p. 48
        if( tv[i,'x'] == '<1' ){
            ## nax (n=1, x=0)
            if( tv[i,'sexo'] == 'feminino' ){ 
                if( tv[1,'nmx'] >= 0.107){ tv[i,'nax'] <- 0.350 }
                else { tv[i,'nax'] <- 0.053 + 2.800 * tv[1,'nmx'] }
            } else { ## sexo == 'masculino' ...
                if( tv[1,'nmx'] >= 0.107){ tv[i,'nax'] <- 0.330 }
                else { tv[i,'nax'] <- 0.045 + 2.684 * tv[1,'nmx'] }
            }
        } else if( tv[i,'x'] == '1-4' ) {
            ## nax (n=4, x=1)
            if( tv[i,'sexo'] == 'feminino' ){
                if( tv[1,'nmx'] >= 0.107){ tv[i,'nax'] <- 1.361 }
                else { tv[i,'nax'] <- 1.522 - 1.518 * tv[1,'nmx'] }
            } else { ## sexo == 'masculino' ...
                if( tv[1,'nmx'] >= 0.107){ tv[i,'nax'] <- 1.352 }
                else { tv[i,'nax'] <- 1.651 - 2.816 * tv[1,'nmx'] }
            }        
        } else { ## (x,x+n) >= '5-9'
            tv[i,'nax'] <- tv[i,'n'] + 1/(tv[i,'nmx']) - tv[i,'n']/(1-exp(-tv[i,'n']*tv[i,'nmx']))
        }
        ## nqx
        if( i < nrow(tv) ) {
            tv[i,'nqx'] <- (tv[i,'n']*tv[i,'nmx'])/(1+(tv[i,'n']-tv[i,'nax'])*tv[i,'nmx'])
        } else {
            tv[i,'nqx'] <- 1
        }
        ## npx
        tv[i,'npx'] <- 1 - tv[i,'nqx']
        ## lx
        if( i==1 ) {
            tv[i,'lx'] <- 1
        } else {
            tv[i,'lx'] <- tv[i-1,'lx'] * tv[i-1,'npx']
        }
        ## ndx
        if( i < nrow(tv) ) {
            tv[i,'ndx'] <- tv[i,'lx'] * tv[i,'nqx']
        } else {
            tv[i,'ndx'] <- tv[i,'lx']
        }
    }
    for( i in 1:nrow(tv)){
        ## nLx
        if( i < nrow(tv) ) {
            tv[i,'nLx'] <- tv[i,'n']*tv[i+1,'lx'] + tv[i,'nax']*tv[i,'ndx']
        } else {
            tv[i,'nLx'] <- tv[i,'lx'] / tv[i,'nmx']
        }
    }
    for( i in 1:nrow(tv)){
        ## Tx
        Tx <- 0
        for( j in i:nrow(tv) ){
            Tx <- Tx + tv[j,'nLx']
        }
        tv[i,'Tx'] <- Tx
        ## ex
        tv[i,'ex'] <- tv[i,'Tx'] / tv[i,'lx']
    }
    return( tv )
}

## Feminina
tvpe2010sim_female <- tabua_vida(
    data.frame(
        sexo = 'feminino',
        tvpe2010censo_female[,'idade'],
        tvpe2010censo_female[,'populacao'],
        pe2010_sim[,'Feminino'] ) %>% # Óbitos do Datasus/SIM
    rename( x = idade, nNx = populacao, nDx = Feminino ) %>%
    mutate(
        nmx = nDx / nNx,
        n = c(1,4, rep(5, 18)),
        nax = 0,
        nqx = 0,
        npx = 0,
        lx = 0,
        ndx = 0,
        nLx = 0,
        Tx = 0,
        ex = 0
    ) 
)

## Masculina
tvpe2010sim_male <- tabua_vida(
    data.frame(
        sexo = 'masculino',
        tvpe2010censo_male[,'idade'],
        tvpe2010censo_male[,'populacao'],
        pe2010_sim[,'Masculino'] ) %>% # Óbitos do Datasus/SIM
    rename( x = idade, nNx = populacao, nDx = Masculino ) %>%
    mutate(
        nmx = nDx / nNx,
        n = c(1,4, rep(5, 18)),
        nax = 0,
        nqx = 0,
        npx = 0,
        lx = 0,
        ndx = 0,
        nLx = 0,
        Tx = 0,
        ex = 0
    ) 
)


## Determinação do nível de mortalidade oeste de Coale & Demeny
tvpe2010sim <- bind_rows(
    tvpe2010sim_female %>% mutate( idade = c(0,1,seq(from = 5, to = 90, by = 5)) ),
    tvpe2010sim_male %>% mutate( idade = c(0,1,seq(from = 5, to = 90, by = 5)) )
) %>%
    mutate(
        idade = factor(
            as.character(idade),
            levels = c(0,1,seq(from = 5, to = 95, by = 5)),
            labels = c('<1','1-4','5-9','10-14','15-19','20-24','25-29',
                       '30-34','35-39','40-44','45-49','50-54','55-59',
                       '60-64','65-69','70-74','75-79','80-84','85-89',
                       '90-94','95+'
                       )
        )
    )

## esperança de vida (e_x)
dat_ex <- bind_rows(
    ex_west_female %>% mutate( sexo = 'feminino', idade = c(0,1,seq(from = 5, to = 95, by = 5)) ),
    ex_west_male %>% mutate( sexo = 'masculino', idade = c(0,1,seq(from = 5, to = 95, by = 5)) )
) %>%
    select( sexo, idade, n1:n25) %>%
    pivot_longer(
        cols = n1:n25
       ,names_to = 'ref'
       ,values_to = 'ex'
    ) %>%
    mutate(
        idade = factor(
            as.character(idade),
            levels = c(0,1,seq(from = 5, to = 95, by = 5)),
            labels = c('<1','1-4','5-9','10-14','15-19','20-24','25-29',
                       '30-34','35-39','40-44','45-49','50-54','55-59',
                       '60-64','65-69','70-74','75-79','80-84','85-89',
                       '90-94','95+'
                       )
        )
    )


## sobreviventes (l_x)
dat_lx <- bind_rows(
    ## Níveis de Mortalidade Coale & Demeny Padrão Oeste
    bind_rows(
        lx_west_female %>% mutate( sexo = 'feminino' ),
        lx_west_male %>% mutate( sexo = 'masculino' )
    ) %>%
    mutate( idade = as.numeric(idade) ) %>%
    select( sexo, idade, n1:n25) %>%
    pivot_longer(
        cols = n1:n25
       ,names_to = 'ref'
       ,values_to = 'lx'
    )
    ## Tábuas de Vida Pernambucanas (Recalculadas usando óbitos do Datasus/SIM)
   ,bind_rows(
        tvpe2010sim_male %>%
        transmute(
            sexo = 'masculino',
            idade = c(0,1,seq(from = 5, to = 90, by = 5)),
            ref = 'lx_PE2010_SIM',
            lx
        ),
        tvpe2010sim_female %>% 
        transmute(
            sexo = 'feminino',
            idade = c(0,1,seq(from = 5, to = 90, by = 5)),
            ref = 'lx_PE2010_SIM',
            lx
        )
    ) 
) %>%
    mutate(
        idade = factor(
            as.character(idade),
            levels = c(0,1,seq(from = 5, to = 95, by = 5)),
            labels = c('<1','1-4','5-9','10-14','15-19','20-24','25-29',
                       '30-34','35-39','40-44','45-49','50-54','55-59',
                       '60-64','65-69','70-74','75-79','80-84','85-89',
                       '90-94','95+'
                       )
        )
    )

## dat_lx %>% View

## Cálculo dos níveis inferiores, superiores e implícitos, esperança de vida implícita e lx padrão de Coale & Demeny
## nvs é abreviação de 'níveis' :)
nvs <- dat_lx %>%
    pivot_wider(
        id_cols = c(sexo, idade ),
        names_from = ref,
        values_from = lx
    ) %>%
    mutate(
        CoaleDemeny_West = '',
        n_inf = 0,
        n_sup = 0,
        lx_inf = 0,
        lx_sup = 0,
        nivel_interpolado = 0,
        ex_implicita = 0,
        e0x_implicita = 0
    ) %>%
    select( sexo, idade, lx_PE2010_SIM, CoaleDemeny_West, n_inf, n_sup, lx_inf, lx_sup, nivel_interpolado, ex_implicita, e0x_implicita, n1:n25 ) %>%
    na.omit() %>%
    as.data.frame

lref <- 'lx_PE2010_SIM'
for(i in 1:nrow(nvs)){
    ## lx_obs < n1 ...
    if( nvs[i,lref] < nvs[i,'n1'] ) {
        nvs[i,'CoaleDemeny_West'] <- 'lx(obs) < lx(n1)'
        nvs[i,'n_inf'] <- 'NA'
        nvs[i,'n_sup'] <- 1
        nvs[i,'lx_inf'] <- nvs[i, lref]  ## nao seria nvs[ i, 'n1'] ??
        nvs[i,'lx_sup'] <- nvs[i, lref]  ## nao seria nvs[ i, 'n1'] ??
        next
    }
    ## lx_obs > n25 ...
    if( nvs[i,lref] > nvs[i,'n25'] ) {
        nvs[i,'CoaleDemeny_West'] <- 'lx(obs) > lx(n25)'
        nvs[i,'n_inf'] <- 25
        nvs[i,'n_sup'] <- 'NA'
        nvs[i,'lx_inf'] <- nvs[i, lref]  ## nao seria nvs[ i, 'n25'] ??
        nvs[i,'lx_sup'] <- nvs[i, lref]  ## nao seria nvs[ i, 'n25'] ??
        next
    }
    ## encontra lx_inf, lx_sup, nível interpolado
    for(j in 12:(ncol(nvs)-1) ){  ## compara lx(obs) com todos os niveis entre n1 e n25 ...
        if( ( nvs[i,lref] >= nvs[i,j] ) & ( nvs[i,lref] <= nvs[i,j+1] ) ){
            nvs[i,'CoaleDemeny_West'] <- paste0( 'lx(',names(nvs)[j], ') <= lx(obs) <= lx(', names(nvs)[j+1],')')
            nvs[i,'n_inf'] <- str_extract( names(nvs)[j], '\\d+')
            nvs[i,'n_sup'] <- str_extract( names(nvs)[j+1], '\\d+')
            nvs[i,'lx_inf'] <- nvs[i, j]
            nvs[i,'lx_sup'] <- nvs[i, j+1]
            ## interpolação linear para encontrar 'nível interpolado'
            nvs[i,'nivel_interpolado'] <- ( nvs[i,lref] - nvs[i,'lx_inf'] ) / ( nvs[i,'lx_sup'] - nvs[i,'lx_inf'] ) + as.numeric( nvs[i,'n_inf'] )
            break
        }
    }
}


## nvs %>% View

## nivel médio
nv_medio <- nvs %>%
    filter( idade %in% c('1-4','5-9','20-24','45-49') ) %>%
    group_by( sexo ) %>%
    summarise(
        nivel_medio = round( mean( nivel_interpolado ), 4 )
       ,fator_nivel_padrao = nivel_medio - floor( nivel_medio) 
    ) 

## tabela 5
nvs %>%
    filter( idade %in% c('1-4','5-9','20-24','45-49') ) %>%
    select( sexo, idade, nivel_interpolado ) %>%
    left_join( nv_medio %>% select( sexo, nivel_medio) ) %>%
    write_csv2( '../data/lab01_ex04_tabela5.csv')
    
nvs <- nvs %>%
    left_join( nv_medio ) %>%
    mutate( lx_padrao = 0 ) 

## nvs %>% View
## nvs %>% names

for( i in 1:nrow(nvs) ) {
    ## nível médio (por sexo) das tábuas de Coale & Demeny (para idades 1, 5, 20 e 45 -- conforme enunciado)
    nv <- floor( nvs[i,'nivel_medio'] )
    fator <- nvs[i,'fator_nivel_padrao']
    ## cálculo da esperança de vida implícita
    ex <- dat_ex %>%
        filter(
            sexo == nvs[i, 'sexo'],
            idade == nvs[i, 'idade'],
            (ref == paste0('n',nv)) | (ref == paste0('n',nv+1))
        ) %>%
        pivot_wider(
            id_cols = c('sexo','idade'),
            names_from = ref,
            values_from = ex
        ) %>%
        rename( inf = 3, sup = 4 )
    nvs[i, 'ex_implicita'] <- ( ex[1,'sup'] - ex[1,'inf'] ) * fator + ex[1,'inf']
    ## cálculo da esperança de vida ao nascer implícita
    e0x <- dat_ex %>%
        filter(
            sexo == nvs[i, 'sexo'],
            idade == '<1',
            (ref == paste0('n',nv)) | (ref == paste0('n',nv+1))
        ) %>%
        pivot_wider(
            id_cols = c('sexo','idade'),
            names_from = ref,
            values_from = ex
        ) %>%
        rename( inf = 3, sup = 4 )
    nvs[i, 'e0x_implicita'] <- ( e0x[1,'sup'] - e0x[1,'inf'] ) * fator + e0x[1,'inf']
    ## cálculo da lx padrão
    lx <- nvs[i, c( paste0('n', nv), paste0('n', nv+1 )) ] %>% rename( inf = 1, sup = 2 )
    nvs[i, 'lx_padrao'] <- ( lx[1,'sup'] - lx[1,'inf'] ) * fator + lx[1,'inf']
}

## Tabela 6 (lx_obs, lx_pd e logitos para adultos/crianças para cálculo do alfa e do beta
logitos <- nvs %>% 
    filter( idade %in% c('1-4','5-9','20-24','45-49') ) %>%
    transmute(
        sexo, idade,
        crianca_adulto = case_when(
            idade %in% c('1-4','5-9') ~ 'c',
            TRUE ~ 'a'
        ),
        lx_obs = lx_PE2010_SIM,
        lx_padrao,
        logito_obs = 0.5 * log( (1 - lx_obs)/ lx_obs),
        logito_padrao = 0.5 * log( (1 - lx_padrao)/ lx_padrao)
    )

logitos %>% 
    write_csv2( '../data/lab01_ex04_tabela6_logitos.csv')

## Tabela 7 (alfa e beta por sexo)
alfa_beta <- logitos %>%
    group_by( sexo, crianca_adulto ) %>%
    summarise(
        avg_obs = mean( logito_obs),
        avg_pd = mean( logito_padrao)
    ) %>%
    pivot_longer( cols = 3:4 ) %>%
    mutate( ref = paste0( crianca_adulto, '_', name ) ) %>%
    pivot_wider( id_cols = sexo, names_from = ref, values_from = value ) %>%
    mutate(
        beta = ( a_avg_obs - c_avg_obs)/( a_avg_pd - c_avg_pd),
        alfa = c_avg_obs - beta*c_avg_pd
    ) 
    
alfa_beta %>% 
    write_csv2( '../data/lab01_ex04_tabela7_alfas_betas.csv')

## Tabela 8
brass <- nvs %>% 
    transmute(
        sexo, idade,
        lx_obs = lx_PE2010_SIM,
        lx_padrao,
        logito_obs = ifelse( lx_obs == 1, NA, 0.5 * log( (1 - lx_obs)/ lx_obs) ),
        logito_padrao = ifelse( lx_padrao == 1, NA, 0.5 * log( (1 - lx_padrao)/ lx_padrao))
    ) %>%
    left_join( alfa_beta %>% select(sexo, alfa, beta) ) %>% 
    mutate(
        logito_estimado = alfa + beta * logito_padrao,
        lx_estimado = ifelse( lx_padrao == 1, 1, 1 / (1 + exp(2*logito_estimado)) )
    )

## brass %>% View

## Cálculo da Tábua de Vida completa (para determinar a esperança de vida)
tvpe2010modrel_female <- brass %>%
    filter( sexo == 'feminino') %>%
    mutate(
        n = c(1,4, rep(5, 17), NA),
        nax = c(0.2,2, rep(2.5, 17), NA),
        nqx = 0,
        ndx = 0,
        nLx = 0,
        Tx = 0,
        ex = 0
    )

tvpe2010modrel_male <- brass %>%
    filter( sexo == 'masculino') %>%
    mutate(
        n = c(1,4, rep(5, 17), NA),
        nax = c(0.2,2, rep(2.5, 17), NA),
        nqx = 0,
        ndx = 0,
        nLx = 0,
        Tx = 0,
        ex = 0
    )

## Tábua de Vida via Modelo Relacional (Pernambuco 2010)
tabua_vida_modrel <- function(tv){ 
    for(i in 1:nrow(tv)){
        ## ndx
        if( i < nrow(tv) ){
            tv[i,'ndx'] <- tv[i,'lx_estimado'] - tv[i+1, 'lx_estimado']
        } else {
            tv[i,'ndx'] <- tv[i,'lx_estimado']
        }
        ## nqx
        tv[i,'nqx'] <- tv[i,'ndx'] / tv[i, 'lx_estimado']
    }
    for( i in 1:nrow(tv)){
        ## nLx
        if( i < nrow(tv) ) {
            tv[i,'nLx'] <- tv[i,'n']*tv[i+1,'lx_estimado'] + tv[i,'nax']*tv[i,'ndx']
        } else {
            tv[i,'nLx'] <- 4.424*tv[i,'lx_estimado'] + 0.0000674*(tv[i,'lx_estimado'])^2 ## de onde vem isso? mistério...
        }
    }
    for( i in 1:nrow(tv)){
        ## Tx
        Tx <- 0
        for( j in i:nrow(tv) ){
            Tx <- Tx + tv[j,'nLx']
        }
        tv[i,'Tx'] <- Tx
        ## ex
        tv[i,'ex'] <- tv[i,'Tx'] / tv[i,'lx_estimado']
    }
    return( tv)
} 

tvpe2010modrel <- bind_rows(
    tabua_vida_modrel( tvpe2010modrel_female ),
    tabua_vida_modrel( tvpe2010modrel_male ) ) 
    
  
tvpe2010censo <- bind_rows( 
    tvpe2010censo_female %>% mutate( sexo = 'feminino', idade, lx_PE2010_Censo = lx / 1e5 ),
    tvpe2010censo_male %>% mutate( sexo = 'masculino', idade, lx_PE2010_Censo = lx / 1e5 )
)


## comparação das esperanças de vida
tvpe2010modrel %>%
    transmute( sexo, idade, ex_modrel = ex ) %>%
    left_join( tvpe2010censo %>% transmute( sexo, idade, ex_censo = ex ) ) %>%
    left_join( tvpe2010sim %>% transmute( sexo, idade, ex_sim = ex ) ) %>%
    filter( idade %in% c('1-4','5-9','20-24','45-49') ) %>%
    write_csv2( '../data/lab01_ex04_compara_ex.csv' )


## --------------------------------------------------------
## comparações entre tábua original do censo, tabua recalculada usando Datasus/SIM e usando modelo relacional de Brass
compara <- bind_rows(
    ## Tábuas de vida originais para Pernambuco ( Censo 2010 )
    tvpe2010censo %>% transmute( fonte = 'PE2010_Censo', sexo, idade, lx = lx/1e5, ex ),
    ## Tábuas de vida recalculadas para Pernambuco usando óbitos do SIM/Datasus
    tvpe2010sim %>% transmute( fonte = 'PE2010_Recalculada_SIM', sexo, idade = x, lx, ex ),
    ## Modelo de Tábua de Vida Relacional (Logito de Brass)
    tvpe2010modrel %>% transmute( fonte = 'Modelo Relacional', sexo, idade, lx = lx_estimado, ex)
) %>%
    mutate(
        idade = factor( idade, levels = 
            c('<1','1-4','5-9','10-14','15-19','20-24','25-29',
              '30-34','35-39','40-44','45-49','50-54','55-59',
              '60-64','65-69','70-74','75-79','80-84','85-89',
              '90-94','95+'
              )
        )
    )
## lx
plot1 <- compara %>%
    ggplot( aes( x = idade, y = lx, group = fonte, color = fonte ) ) +
    geom_line() +
    theme(legend.position = "top", axis.text.x = element_text(angle = 90)) + 
    facet_wrap( ~sexo)

ggsave(filename = '../img/lab01_ex04_lx.png', plot = plot1, width = 8, height = 6)
## ex
plot2 <- compara %>%
    ggplot( aes( x = idade, y = ex, group = fonte, color = fonte ) ) +
    geom_line() +
    theme(legend.position = "top", axis.text.x = element_text(angle = 90)) + 
    facet_wrap( ~sexo)

ggsave(filename = '../img/lab01_ex04_ex.png', plot = plot2, width = 8, height = 6)
## --------------------------------------------------------


## Gráfico comparativo das lx reais (censo e SIM), modelo ajustada e modelo relacional
plot3 <- nvs %>%
    left_join( tvpe2010censo %>% select( sexo, idade, lx_PE2010_Censo ) ) %>%
    left_join( brass %>% transmute( sexo, idade, lx_modelo_relacional = lx_estimado ) ) %>%
    select( sexo, idade, lx_PE2010_SIM, lx_PE2010_Censo, lx_padrao, lx_modelo_relacional ) %>% 
    pivot_longer(
        cols = 3:6,
        names_to = 'tabua',
        values_to = 'lx'
    ) %>%
    ggplot( aes( x = idade, y = lx, group = tabua, color = tabua ) ) +
    geom_line() +
    labs(
        x = 'idade',
        y = 'lx (radix = 1)',
        group = '',
        color = ''
    ) +
    theme(legend.position = "top", axis.text.x = element_text(angle = 90)) + 
    facet_wrap( ~sexo )

ggsave(filename = '../img/lab01_ex04_compara.png', plot = plot3, width = 8, height = 6)


dat <- bind_rows(
    dat_lx,
    tvpe2010censo %>% transmute( sexo, idade, ref = 'lx_PE2010_Censo', lx = lx / 1e5) )

plot4 <- dat %>% 
    filter( ref != 'lx_PE2010_Censo', ref != 'lx_PE2010_SIM' ) %>%
    ggplot( aes( x = idade, y = lx, group = ref ) ) +
    geom_line( color = 'lightgrey'  ) +
    geom_line( aes( x = idade, y = lx, group = ref, color = ref ), data = dat %>% filter( ref == 'lx_PE2010_Censo' ) ) +
    geom_line( aes( x = idade, y = lx, group = ref, color = ref ), data = dat %>% filter( ref == 'lx_PE2010_SIM' ) ) +
    geom_text( aes( x = idade, y = lx, label = ref ), data = dat %>% filter( idade == '55-59', ref != 'lx_PE2010_Censo', ref != 'lx_PE2010_SIM' ), size = 3 ) + 
    labs(
        x = 'idade',
        y = 'lx (radix = 1)',
        group = '',
        color = ''
    ) +
    theme(legend.position = "top", axis.text.x = element_text(angle = 90)) + 
    facet_wrap( ~sexo ) 

ggsave(filename = '../img/lab01_ex04_niveisCD.png', plot = plot4, width = 10, height = 6)
